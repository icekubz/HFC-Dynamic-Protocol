<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CEO Dashboard | Thy Essential</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', sans-serif; }
        .sidebar { width: 250px; background: #0f172a; min-height: 100vh; position: fixed; color: white; padding: 20px; z-index: 999; }
        .nav-item { padding: 12px 20px; color: #94a3b8; cursor: pointer; border-radius: 8px; margin-bottom: 5px; display: flex; align-items: center; }
        .nav-item:hover, .nav-item.active { background: #1e293b; color: white; border-left: 4px solid #fbbf24; }
        .nav-item i { width: 30px; text-align: center; margin-right: 10px; }
        .main { margin-left: 250px; padding: 30px; }
        .section { display: none; }
        .section.active { display: block; }
        .kpi-card { background: white; border-radius: 12px; padding: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-left: 5px solid #0f172a; }
        .kpi-value { font-size: 2rem; font-weight: bold; color: #0f172a; margin-top: 10px; }
        .table-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    </style>
</head>
<body>

    <div class="sidebar d-flex flex-column">
        <h4 class="text-center text-warning fw-bold mb-5"><i class="fa-solid fa-cube"></i> THY ESSENTIAL</h4>

        <div class="nav-item active" id="nav-overview" onclick="switchTab('overview')"><i class="fa-solid fa-chart-line"></i> Profitability</div>
        <div class="nav-item" id="nav-database" onclick="switchTab('database')"><i class="fa-solid fa-users"></i> User Database</div>
        <div class="nav-item" id="nav-controls" onclick="switchTab('controls')"><i class="fa-solid fa-sliders"></i> Master Controls</div>

        <div class="mt-auto">
            <button onclick="resetSystem()" class="btn btn-danger w-100 mb-3 fw-bold"><i class="fa-solid fa-bomb"></i> RESET FINANCIALS</button>
            <button onclick="location.href='dashboard.html'" class="btn btn-outline-secondary w-100 btn-sm">Exit to User View</button>
        </div>
    </div>

    <div class="main">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="fw-bold">CEO Dashboard</h2>
            <div class="text-muted small">System: <span class="text-success fw-bold">ONLINE</span></div>
        </div>

        <div id="overview" class="section active">
            <div class="row g-4 mb-4">
                <div class="col-md-3"><div class="kpi-card" style="border-color: #3b82f6;"><small class="text-muted fw-bold">GROSS REVENUE</small><div class="kpi-value" id="kpi_revenue">$0.00</div></div></div>
                <div class="col-md-3"><div class="kpi-card" style="border-color: #ef4444;"><small class="text-muted fw-bold">TOTAL PAYOUTS</small><div class="kpi-value" id="kpi_payout">$0.00</div></div></div>
                <div class="col-md-3"><div class="kpi-card" style="border-color: #10b981;"><small class="text-muted fw-bold">PLATFORM PROFIT</small><div class="kpi-value" id="kpi_profit">$0.00</div></div></div>
                <div class="col-md-3"><div class="kpi-card" style="border-color: #f59e0b;"><small class="text-muted fw-bold">ACTIVE MEMBERS</small><div class="kpi-value" id="kpi_users">0</div></div></div>
            </div>

            <div class="row">
                <div class="col-md-8">
                    <div class="table-card h-100">
                        <h5 class="mb-4">Financial Trend</h5>
                        <canvas id="financeChart" style="max-height: 300px;"></canvas>
                    </div>
                </div>
                <div class="col-md-4">
                     <div class="table-card h-100 bg-light border-warning">
                        <h5><i class="fa-solid fa-bolt text-warning"></i> Monthly Run</h5>
                        <p class="text-muted small">Calculates Pool & Commissions.</p>
                        <hr>
                        <input type="month" id="batchPeriod" class="form-control mb-3">
                        <button class="btn btn-warning w-100 fw-bold" onclick="runBatch()">RUN BATCH</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="database" class="section">
            <div class="table-card">
                <div class="d-flex justify-content-between mb-3">
                    <h4>Master Affiliate Report</h4>
                    <button class="btn btn-outline-dark btn-sm" onclick="loadReport()"><i class="fa-solid fa-rotate"></i> Refresh</button>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light"><tr><th>User Email</th><th>Role</th><th>Self</th><th>Direct</th><th>Passive (Pool)</th><th>Total</th></tr></thead>
                        <tbody id="reportTable"><tr><td colspan="6" class="text-center py-4">Loading Data...</td></tr></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="controls" class="section">
            <div class="row g-4">
                <div class="col-md-6">
                    <div class="table-card">
                        <h5>ðŸ“¦ Create Package</h5>
                        <hr>
                        <div class="row g-2">
                            <div class="col-12"><input id="pkg_name" class="form-control" placeholder="Name"></div>
                            <div class="col-6"><input id="pkg_price" class="form-control" placeholder="Price"></div>
                            <div class="col-6"><input id="pkg_cv" class="form-control" placeholder="CV"></div>
                            <div class="col-12"><input id="pkg_depth" class="form-control" placeholder="Max Depth"></div>
                            <div class="col-12"><button class="btn btn-dark w-100" onclick="createPackage()">Create</button></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function switchTab(id) {
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById('nav-'+id).classList.add('active');
        }

        async function loadStats() {
            const res = await fetch('/api/admin/stats?t=' + Date.now());
            const data = await res.json();
            document.getElementById('kpi_revenue').innerText = "$" + data.revenue;
            document.getElementById('kpi_payout').innerText = "$" + data.payout;
            document.getElementById('kpi_profit').innerText = "$" + data.profit;
            document.getElementById('kpi_users').innerText = data.users;

            const ctx = document.getElementById('financeChart').getContext('2d');
            if(window.myChart) window.myChart.destroy();
            window.myChart = new Chart(ctx, {
                type: 'bar',
                data: { labels: ['This Month'], datasets: [{ label: 'Revenue', data: [data.revenue], backgroundColor: '#3b82f6' }] },
                options: { responsive: true }
            });
        }

        async function loadReport() {
            const res = await fetch('/api/admin/master-report?t=' + Date.now());
            const data = await res.json();
            const tbody = document.getElementById('reportTable');
            tbody.innerHTML = '';
            data.report.forEach(u => {
                tbody.innerHTML += `<tr><td class="fw-bold">${u.email}</td><td><span class="badge bg-secondary">${u.role}</span></td><td>$${parseFloat(u.self).toFixed(2)}</td><td>$${parseFloat(u.direct).toFixed(2)}</td><td class="text-primary fw-bold">$${parseFloat(u.passive).toFixed(2)}</td><td class="fw-bold text-success">$${parseFloat(u.total).toFixed(2)}</td></tr>`;
            });
        }

        async function runBatch() {
            const period = document.getElementById('batchPeriod').value;
            if(!period) return alert("Select Month");

            const btn = event.target;
            btn.innerText = "Processing...";
            btn.disabled = true;

            const res = await fetch('/api/admin/run-monthly', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({period}) });
            const data = await res.json();
            alert(data.message);

            await loadStats();
            await loadReport();

            btn.innerText = "RUN BATCH";
            btn.disabled = false;

            switchTab('database');
        }

        async function resetSystem() {
            if(!confirm("Reset all financial data?")) return;
            await fetch('/api/admin/reset-system', { method:'POST' });
            alert("Financials Wiped.");
            location.reload();
        }

        async function createPackage() {
            const body = { name: document.getElementById('pkg_name').value, price: document.getElementById('pkg_price').value, cv: document.getElementById('pkg_cv').value, depth: document.getElementById('pkg_depth').value };
            await fetch('/api/admin/create-package', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body) });
            alert("Package Created");
        }

        loadStats();
        loadReport();
    </script>
</body>
</html>
